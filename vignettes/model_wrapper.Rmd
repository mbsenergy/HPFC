---
title: "HPFC Model Details"
author: "Alejandro Abraham"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{HPFC Model Details}
  %\VignetteEngine{knitr::rmarkdown}
---

# Model Sample

This vignette demonstrates how to set up the required directories, load the relevant packages, and retrieve both spot and forward data for gas and power models.

It provides high level model wrapping flow.

## Setup

- Load the necessary packages
- Everything is conducted and determined in the `params.json` file. 

```{r setup, echo = TRUE}
box::use(
    data.table[...],
    magrittr[...],
    echarts4r[...],
    reactable[...]
)

devtools::load_all()
```

## Load Inputs and Retrieve data

```{r, inputs, echo = TRUE}
list_inputs = load_inputs(params_path = "params.json")
# 
# LST_PARAMS <- jsonlite::fromJSON(file.path('params.json'))
# 
#     LST_DIRS = list(
#         dir_data_input_t  = file.path('run', 'LAST', 'data', '01_input'),
#         dir_data_input_f  = file.path('run', 'LAST', 'data', '01_input'),
#         dir_data_inter    = file.path('run', 'LAST', 'data', '01_input'),
#         dir_data_output   = file.path('run', 'LAST', 'data', '02_output'),
#         dir_data_output_models   = file.path('run', 'LAST', 'data', '02_output'),
#         dir_data_other    = file.path('run', 'LAST', 'data', 'xx_other')
#     )
#     
#     LST_DIRS_archive = list(
#         dir_data_input_t  = file.path('run', LST_PARAMS$sim_name, '01_input'),
#         dir_data_input_f  = file.path('run', LST_PARAMS$sim_name, '01_input'),
#         dir_data_inter    = file.path('run', LST_PARAMS$sim_name, '01_input'),
#         dir_data_output   = file.path('run', LST_PARAMS$sim_name, '02_output'),
#         dir_data_output_models   = file.path('run', LST_PARAMS$sim_name, '02_output'),
#         dir_data_other    = file.path('run', LST_PARAMS$sim_name, 'xx_other')
#     )
#     
#     lapply(LST_DIRS_archive, dir.create, recursive = TRUE, showWarnings = FALSE)
#     
#     ### CODES Parameters
#     ENV_CODES = list()
#     ENV_CODES$calendar_holidays = setnames(HPFC::calendar_holidays, paste0("holiday_GR"), 'holiday', skip_absent = TRUE)
#     ENV_CODES$calendar_holidays = ENV_CODES$calendar_holidays[, .(date, holiday)]
#     
#     ENV_CODES$last_date = as.Date(LST_PARAMS$forecast_start) - 1
#     
#     ENV_CODES$calendar_future = copy(ENV_CODES$calendar_holidays)
#     ENV_CODES$calendar_future[,`:=` (year = as.character(data.table::year(date)), 
#                            quarter = as.character(data.table::quarter(date)),
#                            month = as.character(data.table::month(date)))
#                     ]
# 
#     ENV_CODES$calendar_future = ENV_CODES$calendar_future[date >= LST_PARAMS$forecast_start & date <= LST_PARAMS$forecast_end]
#     
#     # A. Spot Market Data
#     
#     ENV_SPOT = list()
#     
#     ENV_SPOT$history_gas_full = HPFC::dt_spot_gas[RIC == HPFC::spot_GAS_products_full[products_GAS %in% unique(c(LST_PARAMS$selected_gas_code, LST_PARAMS$dependent_gas_code))]$spot_GAS_code]
#     ENV_SPOT$history_pwr_full = HPFC::dt_spot_pwr[RIC == HPFC::spot_PWR_products_full[countries %in% LST_PARAMS$selected_pwr_code]$spot_PWR_code]
#     
#     ENV_SPOT$history_gas = ENV_SPOT$history_gas_full[date <= LST_PARAMS$history_end]
#     ENV_SPOT$spot_gas_RIC = unique(HPFC::spot_GAS_products_full[products_GAS %in% c(LST_PARAMS$selected_gas_code, LST_PARAMS$dependent_gas_code)]$spot_GAS_code)
#     
#     ENV_SPOT$history_pwr = ENV_SPOT$history_pwr_full[date <= LST_PARAMS$history_end]
#     ENV_SPOT$spot_pwr_RIC = unique(HPFC::spot_PWR_products_full[countries %in% LST_PARAMS$selected_pwr_code]$spot_PWR_code)
#     
#     
#     if(LST_PARAMS$data_source != 'LOCAL') {
#         ### Connection
#         eikonapir::set_proxy_port(9000L)
#         PLEASE_INSERT_REUTERS_KEY = LST_PARAMS$data_source
#         eikonapir::set_app_id(as.character(PLEASE_INSERT_REUTERS_KEY[1]))
#         
#     }
#     
#     if(LST_PARAMS$data_source != 'LOCAL') {
#         
#         ## GAS
#         if(as.character(LST_PARAMS$forecast_end) >= '2025-01-01') {
#             
#             DT_NEW = HPFC::retrieve_spot(
#                 ric = HPFC::spot_GAS_products_full[products_GAS %in% unique(c(LST_PARAMS$selected_gas_code, LST_PARAMS$dependent_gas_code))]$spot_GAS_code,
#                 from_date = as.character('2025-01-01'),
#                 to_date = as.character(LST_PARAMS$forecast_end),
#                 type = 'GAS')
#             
#             ENV_SPOT$history_gas_full = 
#                 rbind(
#                     ENV_SPOT$history_gas_full,
#                     DT_NEW 
#                 )
#         }
#         
#         ENV_SPOT$history_gas = ENV_SPOT$history_gas_full[date <= LST_PARAMS$history_end]
#         
#         ## PWR
#         if(as.character(LST_PARAMS$forecast_end) >= '2025-01-01') {
#             
#             # DT_NEW = HPFC::retrieve_spot(
#             #     ric = HPFC::spot_PWR_products_full[countries %in% LST_PARAMS$selected_pwr_code]$spot_PWR_code,
#             #     from_date = '2025-01-01',
#             #     to_date = LST_PARAMS$forecast_end,
#             #     type = 'PWR')
#                     # rics_db = data.table::rbindlist(lapply(ric, get_h_rics, from_date = from_date, to_date = to_date))
#             rics_id_24 = c('01','02','03','04','05','06','07','08','09','10','11','12',
#                    '13','14','15','16','17','18','19','20','21','22','23','24')
#             
#             rics = ric
#             rics_id_h = paste0(rics, rics_id_24[1])
#     
#     db_24h = data.table::rbindlist(lapply(1:24, function(i) {
#         rics_id_h = paste0(rics, rics_id_24[i])
#         ### Download Data
#         db =
#             reikonapi::get_series( #eikonapir::get_timeseries
#                 rics =  rics_id_h,
#                 start_date = from_date,
#                 end_date  = to_date,
#                 interval = "daily")
#         
#         ### Adjust data.frame shape
#         if (!is.null(db)) {
#             if (is.na(db[[1]][[1]])) {
#                 
#                 db = data.table(TIMESTAMP = as.Date(paste0(Sys.Date())),
#                                 CLOSE = NA,
#                                 ric_column = NA
#                                 # RIC = rics,
#                                 # TRADED = 0
#                 )
#                 cat(paste(rics, 'founded, no data.'))
#             } else {
#                 db = db[, .(TIMESTAMP = as.Date(substr(TIMESTAMP, 1, 10)), CLOSE, ric_column)]
#             }
#         } else {
#             db = data.table::data.table(TIMESTAMP = as.Date(paste0(Sys.Date())),
#                                         CLOSE = NA,
#                                         ric_column = NA
#                                         # RIC = rics,
#                                         # TRADED = 0
#             )
#             cat(paste(rics, 'not founded.'))
#         }
#         
#         db[, hour := i]
#         print(i)
#         Sys.sleep(1)
#         return(db)
#         
#     }))
#     
#     data.table::setorderv(db_24h, cols = c('TIMESTAMP','hour'), order = 1L)
#     print_retrieval_message(rics = rics, from_date = from_date, to_date = to_date)
# 
#             
#             
#             rics_db = data.table::rbindlist(lapply(ric, get_h_rics, from_date = from_date, to_date = to_date))
#         data.table::setDT(rics_db)
#         
#         rics_db = rics_db[, .(TIMESTAMP, PRICE = CLOSE, RIC = ric_column, HOUR = hour)]
#         rics_db[, TIMESTAMP := as.Date(substr(TIMESTAMP, 1, 10))]
#         
#         downloaded_spot = data.table::copy(rics_db)
#         downloaded_spot = downloaded_spot[, .(date = TIMESTAMP, hour = HOUR, value = PRICE, RIC)]
#         
#         history_pwr_all_s = downloaded_spot[date > from_date]
#         data.table::setorderv(history_pwr_all_s, cols =c('date','hour'), order = -1L)
#         
#         history_ttf_s = history_pwr_all_s[date <= to_date]
#         
#         history_pwr_all_s[, value := as.numeric(value)]
#         history_pwr_all_s[, value := data.table::nafill(value, 'locf'), by = 'RIC']
#         history_pwr_all_s[, value := data.table::nafill(value, 'nocb'), by = 'RIC']
#         
#         history_pwr_all_s[, hour := as.numeric(hour)]
#         history_pwr_all_s[, RIC := substr(RIC, 1, nchar(RIC) - 2)]
#         
#         print_retrieval_done(message = 'Spot Power retrieval finished.')
#         
#         
#             ENV_SPOT$history_pwr_full = 
#                 rbind(
#                     ENV_SPOT$history_pwr_full,
#                     DT_NEW 
#                 )
#             
#                         View(ENV_SPOT$history_pwr_full)
# 
#         }
#         
#         ENV_SPOT$history_pwr = ENV_SPOT$history_pwr_full[date <= LST_PARAMS$history_end]
#         
#     }
#     
#     
#     # B. Forward Market Data
#     ENV_FWD = list()
#     
#     ENV_FWD$fwd_gas_RIC = unique(HPFC::spot_GAS_products_full[products_GAS %in% c(LST_PARAMS$selected_gas_code, LST_PARAMS$dependent_gas_code)]$products_GAS_code)
#     ENV_FWD$fwd_pwr_RIC =  unique(HPFC::spot_PWR_products_full[countries %in% LST_PARAMS$selected_pwr_code]$products_PWR_code)
#     
#     ENV_FWD$time_range = as.numeric(data.table::year(as.Date(LST_PARAMS$forecast_start))):as.numeric(data.table::year(as.Date(LST_PARAMS$forecast_end)))
#     ENV_FWD$calendar = HPFC::calendar_holidays
#     ENV_FWD$calendar[, `:=` (year = as.character(data.table::year(date)), quarter = as.character(data.table::quarter(date)), month = as.character(data.table::month(date)))]
#     
#     DT_GAS = HPFC::dt_fwds_gas[substr(RIC, 1, 4) == HPFC::spot_GAS_products_full[products_GAS %in% unique(c(LST_PARAMS$selected_gas_code, LST_PARAMS$dependent_gas_code))]$products_GAS_code]
#     if(LST_PARAMS$forecast_source == 'FWD') {
#         DT_PWR = HPFC::dt_fwds_pwr_fwddam[spot_PWR_code == HPFC::spot_PWR_products_full[countries %in% LST_PARAMS$selected_pwr_code]$spot_PWR_code, .(date, RIC, value = FWD)]
#     } else {
#         DT_PWR = HPFC::dt_fwds_pwr_fwddam[spot_PWR_code == HPFC::spot_PWR_products_full[countries %in% LST_PARAMS$selected_pwr_code]$spot_PWR_code, .(date, RIC, value = DAM)]
#     }
#     
#     if(LST_PARAMS$data_source == 'LOCAL') {
#         
#         ENV_FWD$dt_fwds = 
#             rbind(DT_GAS,
#                   DT_PWR
#             )
#         
#         ENV_FWD$dt_fwds = ENV_FWD$dt_fwds[ENV_FWD$dt_fwds[, .I[date == max(date)], by = RIC]$V1]
# 
#     } else {
#         
#         ## Generate RICS
#         lst_rics_gas = HPFC::generate_rics_gas(unique(HPFC::spot_GAS_products_full[products_GAS %in% unique(c(LST_PARAMS$selected_gas_code, LST_PARAMS$dependent_gas_code))]$products_GAS_code), time_range = 2025:as.numeric(data.table::year(as.Date(LST_PARAMS$forecast_end))))
#         
#         if(LST_PARAMS$model_type == 'PWR') {
#             ### POWER 
#             lst_rics_pwr = HPFC::generate_rics_pwr(LST_PARAMS$selected_pwr_code, time_range = 2025:as.numeric(data.table::year(as.Date(LST_PARAMS$forecast_end))))
#             
#             ENV_FWD$lst_rics = c(lst_rics_pwr, lst_rics_gas) ; rm(lst_rics_pwr, lst_rics_gas)
#             
#         } else {
#             
#             ENV_FWD$lst_rics = c(lst_rics_gas) ; rm(lst_rics_gas)
#             
#         }
#         
#         ## RETRIEVE
#         ENV_FWD$dt_fwds = 
#             rbind(DT_GAS,
#                   DT_PWR
#             )  
#         
#         ENV_FWD$dt_fwds = ENV_FWD$dt_fwds[ENV_FWD$dt_fwds[, .I[date == max(date)], by = RIC]$V1]
#         
#         if(max(ENV_FWD$time_range) > 2024) {
#             
#             DT_NEW = HPFC::retrieve_fwd(ric = ENV_FWD$lst_rics)
#             
#             ENV_FWD$dt_fwds = rbind(
#                 ENV_FWD$dt_fwds,
#                 DT_NEW
#             )
#             
#             ENV_FWD$dt_fwds = ENV_FWD$dt_fwds[ENV_FWD$dt_fwds[, .I[date == max(date)], by = RIC]$V1]
#             ENV_FWD$dt_fwds = ENV_FWD$dt_fwds[, .(value = trade_close, quote = RIC)]
#         }
#         
#         if (is.null(ENV_FWD$dt_fwds) && nrow(ENV_FWD$dt_fwds) == 0) {
#             
#             stop('NO RAW DATA RETRIEVED')
#             
#         }
#         
#     }
# 
#     ENV_FWD$dt_fwd_gas = HPFC::prep_fwd_curve(DT = ENV_FWD$dt_fwds,
#                                               list_rics = HPFC::spot_GAS_products_full[products_GAS %in% unique(c(LST_PARAMS$selected_gas_code, LST_PARAMS$dependent_gas_code))]$products_GAS_code,
#                                               type = 'GAS',
#                                               start_date = LST_PARAMS$forecast_start,
#                                               end_date = LST_PARAMS$forecast_end, 
#                                               calendar_sim = ENV_FWD$calendar)
# 
#     
#     ENV_FWD$dt_fwd_pwr = HPFC::prep_fwd_curve(DT = ENV_FWD$dt_fwds,
#                                               list_rics = unique(HPFC::spot_PWR_products_full[countries %in% LST_PARAMS$selected_pwr_code]$products_PWR_code),
#                                               type = 'PWR',
#                                               start_date = LST_PARAMS$forecast_start,
#                                               end_date = LST_PARAMS$forecast_end, 
#                                               calendar_sim = ENV_FWD$calendar)
#     
#     ## PREPARE AND RETURN
#     
#     return_list = list(LST_PARAMS, LST_DIRS, LST_DIRS_archive, ENV_CODES, ENV_SPOT, ENV_FWD)
#     names(return_list) = c('LST_PARAMS', 'LST_DIRS', 'LST_DIRS_archive', 'ENV_CODES', 'ENV_SPOT', 'ENV_FWD')
    
```

## Prepare

### Prepare Gas

```{r, prep-gas, echo = TRUE}
ENV_MODELS_GAS = prepare_gas(list_inputs = list_inputs)
```

### Prepare Power

```{r, prep-pwr, echo = TRUE}
ENV_MODELS_PWR = prepare_pwr(list_inputs = list_inputs)
```

## Train

### Train Gas - Long term

```{r, train-gas-lt, echo = TRUE}
ENV_MODELS_GAS$dt_lt_param_gasdep = 
  train_lt_gas(
    gas_data = ENV_MODELS_GAS$dt_lt_param_gasdep,
    ric_gas = unique(ENV_MODELS_GAS$dt_gas$RIC)
  )
```

### Train Power - Long term

```{r, train-pwr-lt, echo = TRUE}
ENV_MODELS_PWR$dt_lt_param_pwr = 
  train_lt_pwr(
    pwr_data = ENV_MODELS_PWR$dt_lt_param_pwr,
    ric_pwr = unique(ENV_MODELS_PWR$dt_pwr$RIC),
    pwr_holidays = ENV_MODELS_PWR$calendar_holidays_pwr,
    gas_history = ENV_MODELS_PWR$gas_history
  )
    
```

### Train Power - Short term

```{r, train-pwr-st, echo = TRUE}
ENV_MODELS_PWR$lst_hr_param_pwr = 
  train_st_pwr(
    pwr_data = ENV_MODELS_PWR$dt_hr_param_pwr,
    gas_history = ENV_MODELS_PWR$gas_history
  )
    
```


## Forecast 

### Preparation
```{r, pred-prep, echo = TRUE}
LST_FOR = list(
    model_lt_gas = copy(ENV_MODELS_GAS$dt_lt_param_gasdep),
    model_lt_pwr = copy(ENV_MODELS_PWR$dt_lt_param_pwr),
    model_st_pwr = copy(ENV_MODELS_PWR$lst_hr_param_pwr),
    dt_gas_fwds = copy(list_inputs$ENV_FWD$dt_fwd_gas),
    dt_pwr_fwds = copy(list_inputs$ENV_FWD$dt_fwd_pwr),
    saved_history_gas = copy(ENV_MODELS_GAS$dt_gas_dd_filt),
    saved_history_gas_bis = copy(ENV_MODELS_GAS$dt_gas_dd_filt),
    saved_history_pwr = copy(ENV_MODELS_PWR$dt_pwr_filt_dd),
    ric_spot_gas = list_inputs$ENV_SPOT$spot_gas_RIC,
    ric_fwd_gas = list_inputs$ENV_SPOT$fwd_gas_RIC,
    ric_spot_pwr = list_inputs$ENV_SPOT$spot_pwr_RIC,
    ric_fwd_pwr = list_inputs$ENV_SPOT$fwd_pwr_RIC,
    calendar_forecast = list_inputs$ENV_CODES$calendar_future,
    last_date = list_inputs$ENV_CODES$last_date
) 

```

### Predict Gas 

```{r, pred-gas, echo = TRUE}
ENV_FOR_GAS = forecast_gas(input_forecast = LST_FOR)
```

### Predict Power 

```{r, pred-pwr, echo = TRUE}
ENV_FOR_PWR = forecast_pwr(input_forecast = LST_FOR, gas_forecast = ENV_FOR_GAS)
```

## Visualization 

### Prepare data for Backtesting

```{r, viz, echo = TRUE}
dt_pwr_for = ENV_FOR_PWR[, .(date, hour, forecast = final_forecast, RIC, season, peak, value_gas, value_bl = spot_forward_month_BL)]
dt_pwr_obs = HPFC::dt_spot_pwr[year(date) %in% unique(year(dt_pwr_for$date)) & RIC == unique(LST_FOR$ric_spot_pwr)][, .(date, hour, spot = value, RIC)]
dt_pwr = merge(dt_pwr_for, dt_pwr_obs, by = c('date', 'hour', 'RIC'))

setcolorder(dt_pwr, c('date', 'hour', 'season', 'peak', 'RIC', 'spot', 'forecast', 'value_bl', 'value_gas'))
setorder(dt_pwr, date, hour)

```

```{r, table data-backtesting}
reactable(dt_pwr)
```

### Daily Curve - Spot, Forecast & Commodities

```{r, viz-predictedobserved}
dt_pwr_lg = melt(dt_pwr, id.vars = c('date', 'hour', 'season', 'peak', 'RIC'), variable.name = 'type', value.name = 'value')
dt_pwr_lg[, .(value = round(mean(value))), by = .(date, type)] %>% 
  group_by(type) %>% 
  e_charts(date) %>% 
  e_line(value, smooth = TRUE, symbol='none') %>% 
  e_legend(show = TRUE, orient = 'horizontal') %>% 
  e_title("Mean Daily Curve", 'Whole period ') %>% 
  e_tooltip(trigger = "axis") %>% 
  e_toolbox_feature(feature = "saveAsImage", title = "Save as image") %>% 
  e_datazoom(start = 0) %>% 
    e_theme('westeros')

```


```{r}

```

